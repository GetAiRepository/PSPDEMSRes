@{
    ViewData["Title"] = "Store Indent Report";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Store Indent Report</h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-primary" onclick="exportReport()">
                            <i class="fas fa-download"></i> Export
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="printReport()">
                            <i class="fas fa-print"></i> Print
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Date Filter Section -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label for="fromDate">FROM DATE:</label>
                            <input type="date" class="form-control" id="fromDate" />
                        </div>
                        <div class="col-md-3">
                            <label for="toDate">TO DATE:</label>
                            <input type="date" class="form-control" id="toDate" />
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="button" class="btn btn-success" onclick="loadReport()">
                                <i class="fas fa-search"></i> View Report
                            </button>
                        </div>
                    </div>

                    <!-- Report Header -->
                    <div id="reportHeader" class="text-center mb-4" style="display: none;">
                        <div class="border p-3">
                            <h4>Unit: ITC LIMITED - PSPD-BCM SARAPAKA</h4>
                            <p class="mb-1">Run Date & Time: <span id="runDateTime"></span></p>
                            <p class="mb-1">Generated By: <span id="generatedBy"></span></p>
                            <h3 class="text-danger mt-3">STORE INDENT</h3>
                        </div>
                    </div>

                    <!-- Report Table -->
                    <div id="reportTable" style="display: none;">
                        <table class="table table-bordered table-striped">
                            <thead class="bg-dark text-white">
                                <tr>
                                    <th>INDENTID</th>
                                    <th>INDENT DATE</th>
                                    <th>MEDICINE NAME</th>
                                    <th>POTENCY</th>
                                    <th>MANUFACTURER NAME</th>
                                    <th>QUANTITY</th>
                                    <th>RAISED BY</th>
                                </tr>
                            </thead>
                            <tbody id="reportData">
                                <!-- Data will be populated here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- No Data Message -->
                    <div id="noDataMessage" class="text-center" style="display: none;">
                        <div class="alert alert-info">
                            <h5><i class="icon fas fa-info"></i> No Data Found!</h5>
                            No store indent records found for the selected date range.
                        </div>
                    </div>

                    <!-- Loading Spinner -->
                    <div id="loadingSpinner" class="text-center" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <p class="mt-2">Loading report data...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Set default dates (current month)
            var now = new Date();
            var firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            var today = new Date();

            $('#fromDate').val(firstDay.toISOString().split('T')[0]);
            $('#toDate').val(today.toISOString().split('T')[0]);

            // Load report on page load
            loadReport();
        });

        function loadReport() {
            var fromDate = $('#fromDate').val();
            var toDate = $('#toDate').val();

            if (!fromDate || !toDate) {
                toastr.error('Please select both From Date and To Date');
                return;
            }

            if (new Date(fromDate) > new Date(toDate)) {
                toastr.error('From Date cannot be greater than To Date');
                return;
            }

            $('#loadingSpinner').show();
            $('#reportTable').hide();
            $('#reportHeader').hide();
            $('#noDataMessage').hide();

            $.ajax({
                url: '@Url.Action("StoreIndentReport", "StoreIndent")',
                type: 'GET',
                data: {
                    fromDate: fromDate,
                    toDate: toDate
                },
                success: function(response) {
                    $('#loadingSpinner').hide();

                    if (response.success && response.data && response.data.length > 0) {
                        populateReportTable(response.data);
                        updateReportHeader(response.reportInfo);
                        $('#reportHeader').show();
                        $('#reportTable').show();
                    } else {
                        $('#noDataMessage').show();
                    }
                },
                error: function(xhr, status, error) {
                    $('#loadingSpinner').hide();
                    toastr.error('Error loading report: ' + error);
                }
            });
        }

        function populateReportTable(data) {
            var tbody = $('#reportData');
            tbody.empty();

            $.each(data, function(index, item) {
                var row = '<tr>' +
                    '<td>' + item.indentId + '</td>' +
                    '<td>' + item.indentDate + '</td>' +
                    '<td>' + item.medicineName + '</td>' +
                    '<td>' + item.potency + '</td>' +
                    '<td>' + item.manufacturerName + '</td>' +
                    '<td>' + item.quantity + '</td>' +
                    '<td>' + item.raisedBy + '</td>' +
                    '</tr>';
                tbody.append(row);
            });
        }

        function updateReportHeader(reportInfo) {
            $('#runDateTime').text(reportInfo.generatedOn);
            $('#generatedBy').text(reportInfo.generatedBy);
        }

        function exportReport() {
            var fromDate = $('#fromDate').val();
            var toDate = $('#toDate').val();

            if (!fromDate || !toDate) {
                toastr.error('Please select date range first');
                return;
            }

            window.location.href = '@Url.Action("ExportStoreIndentReport", "StoreIndent")' +
                '?fromDate=' + fromDate + '&toDate=' + toDate;
        }

        function printReport() {
            if ($('#reportTable').is(':visible')) {
                window.print();
            } else {
                toastr.error('Please load the report first');
            }
        }
    </script>

    <style>
        @@media print {
            .card-header, .btn, .form-control, label, .no-print

        {
            display: none !important;
        }

        .card {
            border: none !important;
            box-shadow: none !important;
        }

        .table {
            font-size: 12px;
        }

            .table th, .table td {
                padding: 4px !important;
            }

        }
    </style>
}