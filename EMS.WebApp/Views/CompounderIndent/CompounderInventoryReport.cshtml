
@{
    ViewData["Title"] = "Compounder Inventory Report";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Compounder Inventory Report</h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-primary" onclick="exportReport()">
                            <i class="fas fa-download"></i> Export
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="printReport()">
                            <i class="fas fa-print"></i> Print
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Date Filter Section -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label for="fromDate">FROM DATE:</label>
                            <input type="date" class="form-control" id="fromDate" />
                        </div>
                        <div class="col-md-3">
                            <label for="toDate">TO DATE:</label>
                            <input type="date" class="form-control" id="toDate" />
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="button" class="btn btn-success" onclick="loadReport()">
                                <i class="fas fa-search"></i> View Report
                            </button>
                        </div>
                    </div>

                    <!-- Report Header -->
                    <div id="reportHeader" class="text-center mb-4" style="display: none;">
                        <div class="border p-3">
                            <h4>Unit: ITC LIMITED - PSPD-BCM</h4>
                            <p class="mb-1">Run Date & Time: <span id="runDateTime"></span></p>
                            <p class="mb-1">Generated By: <span id="generatedBy"></span></p>
                            <h3 class="text-primary mt-3">COMPOUNDER INVENTORY</h3>
                        </div>
                    </div>

                    <!-- Report Table -->
                    <div id="reportTable" style="display: none; overflow-x: auto;">
                        <table class="table table-bordered table-striped table-sm">
                            <thead class="bg-primary text-white">
                                <tr>
                                    <th style="min-width: 80px;">INDENTID</th>
                                    <th style="min-width: 100px;">RAISED DATE</th>
                                    <th style="min-width: 150px;">MEDICINE NAME</th>
                                    <th style="min-width: 80px;">RAISED QUANTITY</th>
                                    <th style="min-width: 80px;">RECEIVED QUANTITY</th>
                                    <th style="min-width: 80px;">POTENCY</th>
                                    <th style="min-width: 120px;">MANUFACTURER BY</th>
                                    <th style="min-width: 80px;">BATCH NO</th>
                                    <th style="min-width: 120px;">MANUFACTURE DATE</th>
                                    <th style="min-width: 100px;">EXPIRY DATE</th>
                                    <th style="min-width: 100px;">RAISED BY</th>
                                </tr>
                            </thead>
                            <tbody id="reportData">
                                <!-- Data will be populated here -->
                            </tbody>
                        </table>
                        
                        <!-- Page Summary -->
                        <div class="text-center mt-3">
                            <strong>Page 1 of 1</strong><br>
                            <small>*******End of Report*******</small>
                        </div>
                    </div>

                    <!-- No Data Message -->
                    <div id="noDataMessage" class="text-center" style="display: none;">
                        <div class="alert alert-info">
                            <h5><i class="icon fas fa-info"></i> No Data Found!</h5>
                            No compounder inventory records found for the selected date range.
                        </div>
                    </div>

                    <!-- Loading Spinner -->
                    <div id="loadingSpinner" class="text-center" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <p class="mt-2">Loading inventory report data...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Set default dates (current month)
            var now = new Date();
            var firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            var today = new Date();
            
            $('#fromDate').val(firstDay.toISOString().split('T')[0]);
            $('#toDate').val(today.toISOString().split('T')[0]);
            
            // Load report on page load
            loadReport();
        });

        function loadReport() {
            var fromDate = $('#fromDate').val();
            var toDate = $('#toDate').val();
            
            if (!fromDate || !toDate) {
                toastr.error('Please select both From Date and To Date');
                return;
            }
            
            if (new Date(fromDate) > new Date(toDate)) {
                toastr.error('From Date cannot be greater than To Date');
                return;
            }
            
            $('#loadingSpinner').show();
            $('#reportTable').hide();
            $('#reportHeader').hide();
            $('#noDataMessage').hide();
            
            $.ajax({
                url: '@Url.Action("CompounderInventoryReport", "CompounderIndent")',
                type: 'GET',
                data: {
                    fromDate: fromDate,
                    toDate: toDate
                },
                success: function(response) {
                    $('#loadingSpinner').hide();
                    
                    if (response.success && response.data && response.data.length > 0) {
                        populateReportTable(response.data);
                        updateReportHeader(response.reportInfo);
                        $('#reportHeader').show();
                        $('#reportTable').show();
                    } else {
                        $('#noDataMessage').show();
                    }
                },
                error: function(xhr, status, error) {
                    $('#loadingSpinner').hide();
                    toastr.error('Error loading inventory report: ' + error);
                }
            });
        }
        
        function populateReportTable(data) {
            var tbody = $('#reportData');
            tbody.empty();
            
            $.each(data, function(index, item) {
                var row = '<tr>' +
                    '<td>' + item.indentId + '</td>' +
                    '<td>' + item.raisedDate + '</td>' +
                    '<td>' + item.medicineName + '</td>' +
                    '<td>' + item.raisedQuantity + '</td>' +
                    '<td>' + item.receivedQuantity + '</td>' +
                    '<td>' + item.potency + '</td>' +
                    '<td>' + item.manufacturerBy + '</td>' +
                    '<td>' + (item.batchNo || '') + '</td>' +
                    '<td>' + (item.manufactureDate || '') + '</td>' +
                    '<td>' + (item.expiryDate || '') + '</td>' +
                    '<td>' + item.raisedBy + '</td>' +
                    '</tr>';
                tbody.append(row);
            });
        }
        
        function updateReportHeader(reportInfo) {
            $('#runDateTime').text(reportInfo.generatedOn);
            $('#generatedBy').text(reportInfo.generatedBy);
        }
        
        function exportReport() {
            var fromDate = $('#fromDate').val();
            var toDate = $('#toDate').val();
            
            if (!fromDate || !toDate) {
                toastr.error('Please select date range first');
                return;
            }
            
            window.location.href = '@Url.Action("ExportCompounderInventoryReport", "CompounderIndent")' +
                '?fromDate=' + fromDate + '&toDate=' + toDate;
        }
        
        function printReport() {
            if ($('#reportTable').is(':visible')) {
                window.print();
            } else {
                toastr.error('Please load the report first');
            }
        }
    </script>
    
    <style>
        @@media print {
            .card-header, .btn, .form-control, label, .no-print { 
                display: none !important; 
            }
            
            .card {
                border: none !important;
                box-shadow: none !important;
            }
            
            .table {
                font-size: 10px;
            }
            
            .table th, .table td {
                padding: 2px !important;
                font-size: 9px;
            }
            
            /* Landscape orientation for better fit */
            @@page {
                size: A4 landscape;
                margin: 0.5in;
            }
        }
        
        /* Make table responsive */
        .table-responsive {
            display: block;
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Zebra striping for better readability */
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(0,0,0,.05);
        }
        
        /* Header styling */
        .bg-primary {
            background-color: #007bff !important;
        }
    </style>
}